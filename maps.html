<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<title>Google Maps API (v3): polyline from directions</title>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		
		<script type="text/javascript">
		
			function initialize() {
				var center = new google.maps.LatLng(24.7756,121.0062);
        var myLatlng = 0;
        var markers = [];
        var contentStrings = [];
        var infowindows = []; 
				
				var map = new google.maps.Map(document.getElementById('map_canvas'), {
			    	center: center,
			    	zoom: 13,
			    	mapTypeId: google.maps.MapTypeId.ROADMAP
			  	});

				var directionsService = new google.maps.DirectionsService(); 
				var request = { 
					origin: "Deblin", 
					destination: "Bialobrzegi", 
					travelMode: google.maps.DirectionsTravelMode.DRIVING 
				}; 

				var polyline = new google.maps.Polyline({
					path: [],
					strokeColor: '#FF0000',
					strokeWeight: 3
				});
				
				directionsService.route(request, function(result, status) { 
					if (status == google.maps.DirectionsStatus.OK) {
            var bounds = new google.maps.LatLngBounds();
						var path = result.routes[0].overview_path;
						var legs = result.routes[0].legs;
            for (i=0;i<legs.length;i++) {
               var steps = legs[i].steps;
               for (j=0;j<steps.length;j++) {
                 var nextSegment = steps[j].path;
                 var heading =0;
                 var TotsegLenght =0;
                 var HeadVar =0;
                 var StartPoint = nextSegment[0];
                 var prevHeading =256;
                 var segLenght =0;
                 
                 for (k=0;k<nextSegment.length;k++) {
                
                    if(k>=1) { 
                      heading = google.maps.geometry.spherical.computeHeading(nextSegment[k-1], nextSegment[k]);
                      if(prevHeading!=256){
                         
                        var tempHead = Math.abs(heading-prevHeading);
                        if(tempHead > 180) tempHead = Math.abs(HeadVar-360);
			HeadVar += tempHead;
                        segLenght = google.maps.geometry.spherical.computeDistanceBetween(nextSegment[k-1], nextSegment[k]);
                      }
                      TotsegLenght+=segLenght;
                      //window.alert("Heading = "+heading+" Lenght ="+segLenght);
                      prevHeading = heading;
                    } 
                    polyline.getPath().push(nextSegment[k]);
                    bounds.extend(nextSegment[k]);
                    myLatlng = nextSegment[k];
                 }
                  markers[j] = new google.maps.Marker({
                    position: myLatlng,
                    map: map,
                    title: 'Uluru (Ayers Rock)'
                  });
		 var DHeadN = HeadVar/TotsegLenght * 100;
                 contentStrings[j] = '<div id="content">'+
                 'Leg '+i+' Segment '+j+' lenght ='+nextSegment.length+' VarHeading = '+HeadVar.toFixed(2)+' TotLenght ='+TotsegLenght.toFixed(2)+' Mark = '+DHeadN.toFixed(2)+'%'+
                 '</div>';
               }
            }          
						polyline.setMap(map);
            map.fitBounds(bounds);
            for (i=0;i<markers.length;i++) {
              infowindows[i] = new google.maps.InfoWindow({
                  content: contentStrings[i] 
              });
              google.maps.event.addListener(markers[i], 'click', (function(i) {
                return function(){
                  infowindows[i].open(map,markers[i]);
                }
              })(i));
            }
                                                
					}
				});
			}
		</script>
		
		<style type="text/css">
			html { height: 100% }
			body { height: 100%; margin: 0px; padding: 0px }
			#map_canvas { height: 100% }
		</style>
	</head>
	<body onload="initialize()">
  		<div id="map_canvas"></div>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-162157-1";
urchinTracker();
</script>

 		
	</body>
</html>

